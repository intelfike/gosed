<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>go edit</title>
<style>
@font-face {
	font-family: 'NotoSansMono';
	src: url('NotoSansCJKjp-hinted/NotoSansMonoCJKjp-Regular.otf');
}

body{font-family:NotoSansMono;}

#editform{border: solid black 1px;}

#linenum{padding-top:4px; float:left; 
	overflow-y:scroll; font-size:16px;}

/*.num{border-top:solid black 1px;}*/

textarea#edit{padding-top:4px; font-size:16px;
	position:relative; left:-12px;
	font-family:NotoSansMono; tab-size:4;}
</style>
</head>
<body>
	<form id="editform">
		<div id="linenum"></div>
		<textarea name="" id="edit" class="edit" cols="100" rows="20"></textarea>
	</form>
</body>
<script>
var edit = document.getElementById("edit")
function save(){
	var xmlhttp = new XMLHttpRequest()
	xmlhttp.onload = function(){
		var res=xmlhttp.responseText // 受信した文字列
	}
	xmlhttp.open("POST", "save", true)
	// xmlhttp.setRequestHeader('Content-Type','application/x-www-form-urlencoded')
	xmlhttp.send("")
}
// テキストを更新するときはこれを使う
function updateEdit(text){
	var cursor = edit.selectionStart
	var scroll = edit.scrollTop
	edit.value = text
	edit.selectionStart = cursor
	edit.selectionEnd = cursor
	updateLineNum()
}
function memsend(){
	// データを同期する
	var xmlhttp = new XMLHttpRequest()
	xmlhttp.onload = function(){
		var res=xmlhttp.responseText // 受信した文字列
	}
	xmlhttp.open("POST", "mem/push", true)
	xmlhttp.send(edit.value)
}
var timeouter
edit.onkeydown = function(e){
	console.log(e)
	
	switch(e.code){	
	case "KeyS":
		if (e.ctrlKey) {
			console.log("ctrl+s")
			save()
			return false
		}
		break
	case "Tab":
		if (e.ctrlKey) {
			return true
		}
		var text = edit.value
		var cursor = edit.selectionStart
		var scroll = edit.scrollTop
		var s = text.substring(0, cursor)
		var e = text.substring(cursor)
		edit.value = s + "\t" + e
		edit.selectionStart = cursor + 1
		edit.selectionEnd = cursor + 1
		edit.scrollTop = scroll
		return false
		break
	}
	updateLineNum()
}
edit.onkeyup = function(){
	clearTimeout(timeouter)
	timeouter = setTimeout(memsend, 500)
	updateLineNum()
}
var linenum = document.getElementById("linenum")
function updateLineNum(){
	len = (edit.value.match(/\n/g)||[]).length+1
	linenum.innerHTML = ''
	maxlen = (len + '').length
	for(let n = 1; n <= len; n++){
		// スペースを挟み込む
		var num = '' + n
		var numlen = num.length
		for(let nn = 0; nn < maxlen - numlen; nn++){
			num = '&nbsp;'+num
		}
		linenum.innerHTML += '<div class="num">'+num+'</div>'
	}
}

edit.onclick = function(e){
	linenum.style.height = edit.offsetHeight - 4 + "px"
}
edit.onmousemove = edit.onclick
// 初期化処理
window.onload = function(){
	pull()
	// file_sync()
	mem_sync()
	edit.onclick()
	edit.focus()
	updateLineNum()
}

edit.onscroll = function(e){
	linenum.scrollTop = edit.scrollTop
}

// 待たずに取ってくる
function pull(){
	var xmlhttp = new XMLHttpRequest()
	xmlhttp.onload = function(){
		var res = xmlhttp.responseText // 受信した文字列
		edit.value = res
		updateLineNum()
	}
	xmlhttp.open("GET", "pull", true)
	xmlhttp.send("pull")
}

// function file_sync(){
// 	var xmlhttp = new XMLHttpRequest()
// 	xmlhttp.onload = function(){
// 		var res = xmlhttp.responseText // 受信した文字列
// 		edit.value = res
// 		updateLineNum()
// 		file_sync()
// 	}
// 	xmlhttp.open("GET", "wait", true)
// 	xmlhttp.send("")
// }
function mem_sync(){
	var xmlhttp = new XMLHttpRequest()
	xmlhttp.onload = function(){
		var res = xmlhttp.responseText // 受信した文字列
		updateEdit(res)
		console.log('sync wait')
		mem_sync()
	}
	xmlhttp.open("GET", "mem/wait", true)
	xmlhttp.send("")	
}
</script>
</html>